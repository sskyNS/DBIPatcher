name: Release DBI Patcher

on:
  push:
    tags:
      - 'v*'  
    paths:
      - 'translate/**.txt'
      - 'DBIPatcher/translate/**.txt'
      - 'dbi_translation_builder.py'  
  pull_request:
    paths:
      - 'translate/**.txt'
      - 'DBIPatcher/translate/**.txt'
      - 'dbi_translation_builder.py'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install MinGW and make
      run: |
        choco install mingw make -y
        echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $env:GITHUB_PATH
        echo "C:\ProgramData\chocolatey\bin" >> $env:GITHUB_PATH
        gcc --version
        make --version

    - name: Build for Windows
      run: |
        make clean
        make -j4

    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: dbipatcher-windows
        path: |
          bin/dbipatcher.exe
          bin/libzstd.dll
        if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential make libzstd-dev

    - name: Build for Linux
      run: |
        make clean
        make -j4

    - name: Upload Linux executable
      uses: actions/upload-artifact@v4
      with:
        name: dbipatcher-linux
        path: bin/dbipatcher
        if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew update
        brew install make zstd
        echo "PATH=/opt/homebrew/bin:/usr/local/bin:$PATH" >> $GITHUB_ENV

    - name: Build for macOS
      run: |
        make clean
        make -j4

    - name: Upload macOS executable
      uses: actions/upload-artifact@v4
      with:
        name: dbipatcher-macos
        path: bin/dbipatcher
        if-no-files-found: error

  build-translations:
    runs-on: windows-latest
    needs: [build-windows]  
    if: contains(github.event.head_commit.message, 'translate') || contains(github.event.head_commit.message, 'translation') || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: dbipatcher-windows
        path: bin/

    - name: Install Python (运行脚本依赖)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'  

    - name: Install make and tools
      run: |
        choco install make -y
        echo "C:\ProgramData\chocolatey\bin" >> $env:GITHUB_PATH
        make --version  

    - name: 检查基础DBI文件（必须存在，否则无法构建）
      run: |
        echo "Checking base DBI file: dbi/DBI.810.ru.nro"
        if (-not (Test-Path "dbi/DBI.810.ru.nro")) {
            echo "ERROR: 基础文件 dbi/DBI.810.ru.nro 不存在！"
            echo "请将原始DBI文件放入 dbi/ 目录后重试。"
            exit 1
        } else {
            $fileSize = [math]::Round((Get-Item 'dbi/DBI.810.ru.nro').Length/1MB, 2)
            echo "✓ 找到基础文件（大小：$fileSize MB）"
        }

    - name: 运行Python脚本（自动构建所有语言）
      run: |
        # 设置控制台编码为UTF-8并运行Python脚本
        chcp 65001
        python -X utf8 dbi_translation_builder.py --build-all
      env:
        PYTHONIOENCODING: utf-8
        PATH: ${{ env.PATH }};C:\ProgramData\chocolatey\bin;C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin

    - name: 验证翻译文件生成
      run: |
        $outputDir = "temp/DBI_810/bin"
        if (-not (Test-Path $outputDir)) {
            echo "ERROR: 翻译输出目录 $outputDir 不存在"
            exit 1
        }
      
        $transFiles = Get-ChildItem -Path $outputDir -Filter "DBI.810.*.nro" -Recurse
        if ($transFiles.Count -eq 0) {
            echo "ERROR: 未生成任何翻译文件"
            exit 1
        }
        echo "✓ 成功生成 $($transFiles.Count) 个翻译文件："
        foreach ($file in $transFiles) {
            $fileSize = [math]::Round($file.Length/1KB, 2)
            echo "  - $($file.Name) ($fileSize KB)"
        }

    - name: 上传翻译文件Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dbi-translated-versions
        path: temp/DBI_810/bin/
        if-no-files-found: error

    - name: 生成翻译构建报告
      run: |
        $summary = "## DBI Translation Build Report`n`n"
        $summary += "**Build Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')`n"
        $summary += "**Commit Hash:** $env:GITHUB_SHA`n"
        $summary += "**Tag:** $($env:GITHUB_REF -replace 'refs/tags/','')`n`n"
        
        $outputDir = "temp/DBI_810/bin"
        $transFiles = Get-ChildItem -Path $outputDir -Filter "DBI.810.*.nro" -Recurse
        $summary += "### 生成的翻译文件（共 $($transFiles.Count) 个）`n"
        foreach ($file in $transFiles) {
            $fileSize = [math]::Round($file.Length/1KB, 2)
            $summary += "- $($file.Name) ($fileSize KB)`n"
        }
        
        # 保存报告
        $summary | Out-File -FilePath "translation-report.md" -Encoding UTF8
        Get-Content "translation-report.md"

    - name: 上传构建报告
      uses: actions/upload-artifact@v4
      with:
        name: translation-report
        path: translation-report.md
        if-no-files-found: warn

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos, build-translations]
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
  
    - name: 下载所有构建产物
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: 整理Release资产
      run: |
        mkdir -p release_assets
        
        # 1. 整理各平台工具
        cp artifacts/dbipatcher-windows/dbipatcher.exe release_assets/dbipatcher-windows-${{ github.ref_name }}.exe
        cp artifacts/dbipatcher-windows/libzstd.dll release_assets/libzstd.dll
        cp artifacts/dbipatcher-linux/dbipatcher release_assets/dbipatcher-linux-${{ github.ref_name }}
        chmod +x release_assets/dbipatcher-linux-${{ github.ref_name }}
        cp artifacts/dbipatcher-macos/dbipatcher release_assets/dbipatcher-macos-${{ github.ref_name }}
        chmod +x release_assets/dbipatcher-macos-${{ github.ref_name }}
        
        if [ -d "artifacts/dbi-translated-versions" ]; then
          mkdir -p release_assets/translations
          cp -r artifacts/dbi-translated-versions/* release_assets/translations/
          zip -r release_assets/dbi-translations-${{ github.ref_name }}.zip release_assets/translations/
          rm -rf release_assets/translations 
        fi
        
        if [ -f "artifacts/translation-report/translation-report.md" ]; then
          cp artifacts/translation-report/translation-report.md release_assets/
        fi
        
        echo "=== 最终Release资产 ==="
        ls -la release_assets/

    - name: 创建GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: DBI Patcher ${{ github.ref_name }}
        body: |
          ## DBI Patcher 自动构建发布
          
          ### 包含内容
          - 各平台工具（Windows/Linux/macOS）
          - 多语言翻译包（已压缩）
          - 构建报告
          
          ### 使用说明
          1. 下载对应平台的工具（如Windows用户下载 dbipatcher-windows-${{ github.ref_name }}.exe）
          2. 下载翻译包（dbi-translations-${{ github.ref_name }}.zip）
          3. 运行工具：`./dbipatcher --help` 查看命令
          
          ### 翻译支持语言
          自动构建所有配置的语言（详见 translation-report.md）
        draft: false
        prerelease: false
        files: |
          release_assets/*
